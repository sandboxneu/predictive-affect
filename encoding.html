<!DOCTYPE html>
<html>
  <head>
    <title>Encoding Phase</title>
    <meta charset="UTF-8">
    <script src="node_modules/jspsych/jspsych.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-instructions.js"></script>
    <script src="constants.js" type="module"></script>
    <script src="utils.js"></script>
    <link href="predictiveaffect.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

  const timeline = [];

  // BEGIN INSTRUCTIONS

  const encodingInstructionsPanel1 = {
    type: 'html-keyboard-response',
    stimulus: 'In the first part of the experiment, a series of images will appear on the screen, one after the other.\n\nThese images will have a grey patch on them.\n\nIf you see a grey patch on the left side of the picture, please press the button \"J\" as quickly as possible. If you see a grey patch on the right side of the picture, please press the button \“K\” as quickly as possible.\n\nPlease make sure you always use the same fingers to press the buttons. \n\nYou will see many images, so we will give you breaks periodically.\n\nIf at any point of this part of the experiment that you want to quit, please press "Q".\n\nTo continue, please press "K".',
    choices: ['k'],
  };

  const encodingInstructionsPanel2 = {
    type: 'html-keyboard-response',
    stimulus: 'Next, you will see a screen with a dot representing the center. Then, the image trialing will start.\nPress "J" to continue.',
    choices: ['j'],
  };
  
  timeline.push(encodingInstructionsPanel1);
  timeline.push(encodingInstructionsPanel2);
  // END INSTRUCTIONS
  
  // CREATE TIMELINE
  
  for (block = 0; block < param['encodingBlocks']; block += 1) {
    exemplarCounts = createExemplarCounts();
    exemplarNames = Object.keys(exemplarCounts);
    for (trial = 0; trial < param['trialsPerEncodingBlock']; trial += 1) {
      // PUSH TRIAL
      
      // SELECT AN EXEMPLAR
      const curExemplar = randomlyPickFromList(exemplarNames);
      exemplarCounts[curExemplar] -= 1;
      if (exemplarCounts[curExemplar] = 0) {
        removeElement(exemplarNames, curExemplar);
      }
      // DISPLAY ITS IMAGES
      for (let subTrial = 0; subTrial < exemplars[curExemplar].getImages().length; subTrial += 1) {
        showFixationDot(timeline)
        const image = exemplars[curExemplar].getImage(subTrial);
        const curTrial = {
          type: 'html-keyboard-response',
          stimulus: generateImageHTML(image),
          choices: ['j','k'],
          trial_duration: param['display_time'] * 1000,
          response_ends_trial: false,
        }
        timeline.push(curTrial);
        trial += 1;
      }
    }
    if (block != param['encodingBlock']) {
      showFixationDot(timeline); // TODO change this to actually have an intertrial break
    }
      
  }

  jsPsych.init({
    timeline: timeline,
  });
  </script>
</html>
