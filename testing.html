<!DOCTYPE html>
<html>
  <head>
    <title>Testing Phase</title>
    <script src="node_modules/jspsych/jspsych.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-instructions.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <link href="predictiveaffect.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

  // constants
  const timeline = [];
  const imageStructLength = 3;

  const exemplarsPerTripletType = 2;
  const tripletTypes = ["NeuNeuNeu", "AffAffAff", "NeuNeuAff", "AffNeuNeu"];
  const numTripletTypes = tripletTypes.length;
  const numExemplars = exemplarsPerTripletType * numTripletTypes;

  // hardcoded for now
  const negImages = ['9909.jpg', '7380.jpg', '9530.jpg', '3261.jpg', '6315.jpg', '9571.jpg', '9412.jpg', '2456.jpg', '9220.jpg', '3019.jpg', '2352.2.jpg', '9187.jpg', '2811.jpg', '9006.jpg', '9183.jpg', '9927.jpg', '2688.jpg', '9414.jpg', '3350.jpg', '3212.jpg', '3001.jpg', '9280.jpg', '3170.jpg', '9140.jpg', '9181.jpg', '2301.jpg', '2799.jpg', '2800.jpg', '3230.jpg', '6312.jpg', '6821.jpg', '3550.1.jpg', '9043.jpg', '2683.jpg', '9561.jpg', '3300.jpg', '3053.jpg', '2053.jpg', '3180.jpg', '2751.jpg', '9600.jpg', '9570.jpg', '9295.jpg', '9410.jpg', '6825.jpg', '3195.jpg', '3160.jpg', '9342.jpg', '2345.1.jpg', '9810.jpg', '3064.jpg', '9265.jpg', '2141.jpg', '9185.jpg', '3120.jpg', '9413.jpg', '6563.jpg', '9325.jpg', '9635.1.jpg', '9041.jpg', '6243.jpg', '9921.jpg', '9831.jpg', '3015.jpg', '9560.jpg', '6571.jpg', '2710.jpg', '2205.jpg', '9415.jpg', '2900.jpg', '9520.jpg', '2730.jpg', '9424.jpg', '9800.jpg', '3400.jpg', '9301.jpg', '9332.jpg', '9075.jpg', '9254.jpg'];
  const neuImages = ['1908.jpg', '2101.jpg', '2191.jpg', '1945.jpg', '1390.jpg', '2520.jpg', '2107.jpg', '2393.jpg', '2484.jpg', '2597.jpg', '2020.jpg', '1903.jpg', '2309.jpg', '1645.jpg', '1114.jpg', '2635.jpg', '2272.jpg', '1302.jpg', '1122.jpg', '2383.jpg', '2359.jpg', '2840.jpg', '2575.jpg', '2122.jpg', '2890.jpg', '2220.jpg', '2411.jpg', '1617.jpg', '1670.jpg', '2384.jpg', '2749.jpg', '1935.jpg', '2279.jpg', '2397.jpg', '2210.jpg', '2377.jpg', '2579.jpg', '2458.jpg', '2445.jpg', '2308.jpg', '2446.jpg', '1560.jpg', '2032.jpg', '2206.jpg', '2221.jpg', '2752.jpg', '1947.jpg', '1931.jpg', '2435.jpg', '2102.jpg', '2235.jpg', '2396.jpg', '1230.jpg', '2215.jpg', '2695.jpg', '2745.1.jpg', '2521.jpg', '2870.jpg', '1726.jpg', '1350.jpg', '2704.jpg', '1820.jpg', '1675.jpg', '2606.jpg', '1616.jpg', '2770.jpg', '2850.jpg'];
  const triplets = [['2101.jpg', '1908.jpg', '2191.jpg'], ['9571.jpg', '9412.jpg', '2456.jpg'], ['9571.jpg', '9412.jpg', '2456.jpg'], ['9571.jpg', '9412.jpg', '2456.jpg']]; 

  const totalNumImages = neuImages.length;
  const totalNumTriplets = triplets.length;

  const allTripConditions = generateConditions();
  const foils = createFoils();  


  // number of AAA triplets that have been tested on first A (no more than half of exemplarsPerTripletType)
  var AAACount = 0;
  // number of NNN triplets that have been tested on first N (no more than half of exemplarsPerTripletType)
  var NNNCount = 0;
  // number of images(one per exemplar) tested on same image type (no more than half of numExemplars)
  var sameCatTested = 0;

  // determines if a given image is negative 
  function isNegative(imgName){
     return negImages.includes(imgName);
  }

  // creates the condition for every triplet
  function generateConditions(){
    const condition = [];
    const allConditions = [];
    for (let i = 0; i < totalNumTriplets; i++) {
      for (let j = 0; j < imageStructLength; j++) {
        condition[j] = (isNegative(triplets[i][j])) ? "Aff" : "Neu";
      } 
      allConditions[i] = condition;
    } 
    return allConditions;
  }

  // returns a random image 
  function getRandImg(curType, curTrip){
    var newImg = curTrip[0];
    var sameImages = negImages;
    var oppositeImages = negImages;

    if (curType === "Neu") {
      oppositeImages = neuImages;
    } else {
      sameImages = neuImages;
    }

    if ((sameCatTested >= (numExemplars / 2)) || (Math.random() > 0.5)){
      var temp = sameImages;
      sameImages = oppositeImages;
      oppositeImages = sameImages;
    }

    while(curTrip.includes(newImg)){
      var rand = Math.round((Math.random() * (totalNumImages - 1)));
      newImg = sameImages[rand];
    }
    return newImg;
  }

  //TODO: extend to more triplet types, ie AffAffNeu
  // creates a random foil for a single triplet
  function createFoil(curTrip, curTripCond) {
    var result = curTrip.slice();
    switch(curTripCond.join('')) {
          //half last, half first
          case "NeuNeuNeu": 
            if ((NNNCount >= (exemplarsPerTripletType / 2) || (Math.random > 0.5))){
              result[2] = getRandImg("Neu", curTrip);
            } else {
              result[1] = getRandImg("Neu", curTrip);
            }
            break;
          //half last, half first  
          case "AffAffAff":
            if ((AAACount >= (exemplarsPerTripletType / 2)) || (Math.random > 0.5)){
              result[2] = getRandImg("Aff", curTrip);
            } else {
              result[1] = getRandImg("Neu", curTrip);
            }
            break;
          //last  
          case "NeuNeuAff":
            result[2] = getRandomImg("Aff", curTrip);
            break;
          //first  
          case "AffNeuNeu":
            result[1] = getRandomImg("Aff", curTrip)
            break;
    }
    return result;
  }

  function createFoils(){
    result = [];
    for(let i = 0; i < totalNumTriplets; i++){
      result[i] = createFoil(triplets[i], allTripConditions[i]);
    }
    return result;
  }

  // returns the foil of the given triplet
  function getFoil(correctTriplet, i){
    return foils[i];
  }

  // TODO
  function showFixationDot(){
    return;
  }

  const testingInstructions = {
    type: 'instructions',
    pages: ['<div><p>In this part of the experiment, you will see two groups of images: Group A and Group B. Each group includes three images, which will appear one after the other.</p> <p>Your job is to indicate which group looks most familiar. Please pay close attention when the images are shown, as they will not be repeated.</p> <p>First, we will show you Groups A and B. After seeing all groups, you will decide which group looks most familiar.</p><p>To start the experiment, please press "J".</p><p>To see the instructions again, please press "F".</p></div>'],
    key_forward: 'j',
  };
   
  timeline.push(testingInstructions);
  
  // displys the instructions and three images for a given triplet
  function displayTriplet(trip, ordering){
    const instructText = "<div> <p> To see Group " + ordering + ", please press “J”. Three images will appear, one after the other.</p> </div>"; 

    const tripletInstructions = {
      type: 'instructions',
      pages: [instructText],
      key_forward: 'j',
    };

    timeline.push(tripletInstructions);

    for (let i = 0; i < imageStructLength; i++){

      const stimType = (isNegative(trip[i])) ? "negative" : "neutral";
      const imgName = "assets/stimuli/" + stimType + "/" + trip[i];

      showFixationDot();

      const imagePrompt = {
        type: 'image-keyboard-response',
        stimulus: imgName,
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000,        
      };

      timeline.push(imagePrompt);
      
    }
  }

  // asks the user what the correct triplet is
  function promptCorrectTrip(tripA, tripB, ordering){
    var foilDif = 0;
    for (let i = 0; i < imageStructLength; i++){
      if (tripA[i] != tripB[i]){
        foilDif = i + 1;
      }
    }
    const askPrompt = {
      type: 'html-keyboard-response',
      stimulus: ['<div><p>Using the mouse, if the image sequence in Option A looked more familiar, click “A”.</p><p>If the image sequence in Option B looked more familiar, click “B”.</p> <p>To continue, press "Enter".</p></div>'], 
      choices: ['a', 'b'],
    };

    const textPrompt = {
      type: 'instructions',
      pages: ['<div><p>Using the mouse, if the image sequence in Option A looked more familiar, click “A”.</p><p>If the image sequence in Option B looked more familiar, click “B”.</p> <p>To continue, press "Enter".</p></div>'], 
      key_forward: 'enter',
      data: {tripOrdering: ordering, foilDifference: foilDif},
    };

    timeline.push(askPrompt);
    timeline.push(textPrompt);
    
  }

  for (let i = 0; i < triplets.length; i++){
    const curTriplet = triplets[i];
    const foil = getFoil(curTriplet, i);
    const ordering = (Math.random() > 0.5) ? ["correct", "foil"] : ["foil", "correct"];
  
    const tripA = (ordering[0] === "correct") ? curTriplet : foil;
    const tripB = (tripA === curTriplet) ? foil : curTriplet;
  
    displayTriplet(tripA, "A");
    displayTriplet(tripB, "B");
    promptCorrectTrip(tripA, tripB, ordering);

  }

  const testingFinish = {
    type: 'instructions',
    pages: ['<div> <p> Thank you for finishing this part of the experiment. </p> <p>To continue, press "J".</p></div>'],
    key_forward: 'j',
  };

  timeline.push(testingFinish);

  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
        jsPsych.data.displayData();
      }
  });

  </script>
</html>
