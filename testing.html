<!DOCTYPE html>
<html>
  <head>
    <title>Testing Phase</title>
    <script src="node_modules/jspsych/jspsych.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-instructions.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="utils.js"></script>
    <link href="predictiveaffect.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

  // constants
  const timeline = [];
  const imageStructLength = 3;

  const exemplarsPerTripletType = 2;
  const numTripletTypes = tripletTypes.length;
  const numExemplars = exemplars.length;

  const foilDifferences = [];

  const totalNumImages = neuImages.length;
  const totalNumTriplets = exemplars.length;

  const allTripConditions = generateConditions();
  const foils = createFoils();  

  // number of AAA triplets that have been tested on first A (no more than half of exemplarsPerTripletType)
  var AAACount = 0;
  // number of NNN triplets that have been tested on first N (no more than half of exemplarsPerTripletType)
  var NNNCount = 0;
  // number of images(one per exemplar) tested on same image type (no more than half of numExemplars)
  var sameCatTested = 0;

  // determines if a given image is negative 
  function isNegative(imgName){
     return negImages.includes(imgName);
  }

  // creates the condition for every triplet
  function generateConditions(){
    const condition = [];
    const allConditions = [];
    for (i in exemplars) {
      for (let j = 0; j < imageStructLength; j++) {
        condition[j] = (isNegative(exemplars[i][j])) ? "B" : "N";
      } 
      allConditions[i] = condition;
    } 
    return allConditions;
  }

  // returns a random image 
  function getRandImg(curType, curTrip){
    var newImg = curTrip[0];
    var sameImages = negImages.slice();
    var oppositeImages = negImages.slice();

    if (curType === "N") {
      oppositeImages = neuImages.slice();
    } else {
      sameImages = neuImages.slice();
    }

    if ((sameCatTested >= (numExemplars / 2)) || (Math.random() > 0.5)){
      var temp = sameImages.slice();
      sameImages = oppositeImages.slice();
      oppositeImages = sameImages.slice();
    }

    while(curTrip.includes(newImg)){
      var rand = Math.round((Math.random() * (totalNumImages - 1)));
      newImg = sameImages[rand];
    }
    return newImg;
  }

  // creates a random foil for a single triplet
  function createFoil(curTrip, curTripCond) {
    var result = curTrip.slice();
    switch(curTripCond.join('')) {
        //half last, half first
        case "NNN": 
          if ((NNNCount >= (exemplarsPerTripletType / 2) || (Math.random > 0.5))){
            result[2] = getRandImg("N", curTrip);
          } else {
            result[1] = getRandImg("N", curTrip);
          }
          break;
        //half last, half first  
        case "BBB":
          if ((AAACount >= (exemplarsPerTripletType / 2)) || (Math.random > 0.5)){
            result[2] = getRandImg("B", curTrip);
          } else {
            result[1] = getRandImg("N", curTrip);
          }
          break;
        //last  
        case "NNB":
          result[2] = getRandomImg("B", curTrip);
          break;
        //first  
        case "BNN":
          result[1] = getRandomImg("B", curTrip)
          break;
    }
    return result;
  }

  // creates a foil for every exemplar
  function createFoils(){
    result = [];
    for(i in exemplars){
      result[i] = createFoil(exemplars[i], allTripConditions[i]);
    }
    return result;
  }

  // returns the foil of the given triplet
  function getFoil(correctTriplet, i){
    return foils[i];
  }

  function showFixationDot(){
    const whiteDot = {
      type: 'image-keyboard-response',
      stimulus: 'assets/whitedot.png',
      trial_duration: 500,
    };
    timeline.push(whiteDot);
  }

  const testingInstructions = {
    type: 'instructions',
    pages: ['<div><p>In this part of the experiment, you will see two groups of images: Group A and Group B. Each group includes three images, which will appear one after the other.</p> <p>Your job is to indicate which group looks most familiar. Please pay close attention when the images are shown, as they will not be repeated.</p> <p>First, we will show you Groups A and B. After seeing all groups, you will decide which group looks most familiar.</p><p>To start the experiment, please press "J".</p><p>To see the instructions again, please press "F".</p></div>'],
    key_forward: 'j',
  };
   
  timeline.push(testingInstructions);
  
  // displys the instructions and three images for a given triplet
  function displayTriplet(trip, ordering){
    const instructText = "<div> <p> To see Group " + ordering + ", please press “J”. Three images will appear, one after the other.</p> </div>"; 

    const tripletInstructions = {
      type: 'instructions',
      pages: [instructText],
      key_forward: 'j',
    };

    timeline.push(tripletInstructions);

    for (let i = 0; i < imageStructLength; i++){
      const stimType = (isNegative(trip[i])) ? "negative" : "neutral";
      const imgName = "assets/stimuli/" + stimType + "/" + trip[i];

      showFixationDot();

      const imagePrompt = {
        type: 'image-keyboard-response',
        stimulus: imgName,
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000,        
      };

      timeline.push(imagePrompt);
      
    }
  }

  // asks the user what the correct triplet is
  function promptCorrectTrip(tripA, tripB, ordering){
    var foilDif = 0;
    var sameCat = false;
    var foil = tripA.slice();
    var correct = tripA.slice();
    for (let i = 0; i < imageStructLength; i++){
      if (tripA[i] != tripB[i]){
        foilDif = i + 1;
        if (isNegative(tripA[i]) === isNegative(tripB[i])){
          sameCat = true;
        }
      }
    }
    if (ordering[0] === "correct") {
      foil = tripB.slice();
    } else {
      correct = tripB.slice();
    }

    const askPrompt = {
      type: 'html-keyboard-response',
      stimulus: ['<div><p>Using the mouse, if the image sequence in Option A looked more familiar, click “A”.</p><p>If the image sequence in Option B looked more familiar, click “B”.</p> <p>To continue, press "Enter".</p></div>'], 
      choices: ['a', 'b'],
      data: {foilTrip: foil, correctTrip: correct, tripOrdering: ordering, foilDifference: foilDif, sameCategoryTested: sameCat},
      on_finish: function(data){
        if (((ordering[0] == "correct") && (data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('a'))) ||
          ((ordering[0] == "incorrect") && (data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('b')))){
            data.correct = 2;
          } else {
            data.correct = (sameCat) ? 1 : 0;
          }
      }
    };

    const textPrompt = {
      type: 'instructions',
      pages: ['<div><p>Using the mouse, if the image sequence in Option A looked more familiar, click “A”.</p><p>If the image sequence in Option B looked more familiar, click “B”.</p> <p>To continue, press "Enter".</p></div>'], 
      key_forward: 'enter',
      
    };

    timeline.push(askPrompt);
    timeline.push(textPrompt);
    
  }

  // for every exemplar, display the exemplar and foil
  for (i in exemplars){
    const curTriplet = exemplars[i];
    const foil = getFoil(curTriplet, i);
    const ordering = (Math.random() > 0.5) ? ["correct", "foil"] : ["foil", "correct"];
  
    const tripA = (ordering[0] === "correct") ? curTriplet : foil;
    const tripB = (tripA === curTriplet) ? foil : curTriplet;
  
    displayTriplet(tripA, "A");
    displayTriplet(tripB, "B");
    promptCorrectTrip(tripA, tripB, ordering);
  }

  const testingFinish = {
    type: 'instructions',
    pages: ['<div> <p> Thank you for finishing this part of the experiment. </p> <p>To continue, press "J".</p></div>'],
    key_forward: 'j',
  };

  timeline.push(testingFinish);

  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
        jsPsych.data.displayData();
      }
  });

  </script>
</html>
