<!DOCTYPE html>
<html>
  <head>
    <title>Testing Phase</title>
    <script src="node_modules/jspsych/jspsych.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-instructions.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="node_modules/jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="utils.js"></script>
    <link href="predictiveaffect.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

  // constants
  const timeline = [];
  const imageStructLength = 3;

  const exemplarsPerTripletType = 2;
  const numTripletTypes = tripletTypes.length;
  const numExemplars = exemplars.length;

  const totalNumNegImages = negImages.length;
  const totalNumNeuImages = neuImages.length;

  // number of AAA triplets that have been tested on first A (no more than half of exemplarsPerTripletType)
  var AAACount = 0;
  // number of NNN triplets that have been tested on first N (no more than half of exemplarsPerTripletType)
  var NNNCount = 0;
  // number of images(one per exemplar) tested on same image type (no more than half of numExemplars)
  var sameCatTested = 0;

  // returns a random image 
  const getRandImg = (curType, curTrip) => {
    // var newImg = new image();
    var newImg = curTrip.getImage(0);
    var sameImages = negImages.slice();
    var oppositeImages = negImages.slice();

    if (curType === 'N') {
      oppositeImages = neuImages.slice();
    } else {
      sameImages = neuImages.slice();
    }

    if ((sameCatTested >= (numExemplars / 2)) || (Math.random() > 0.5)){
      var temp = sameImages.slice();
      sameImages = oppositeImages.slice();
      foilType = (curType === 'N') ? 'N' : 'B';
    } else {
      foilType = (curType === 'N') ? 'B' : 'N';
    }

    const numImages = (foilType === 'N') ? totalNumNeuImages : totalNumNegImages;

    while(curTrip.getImages().includes(newImg)) {
      var rand = Math.floor((Math.random() * numImages));
      
      newImg = sameImages[rand];
     
    }

    return {fileName: newImg,
            dotPlacement: 'N/A: foil',
            valence: foilType,};
  };

  // creates a random foil for a single exemplar
  const createFoil = (curTrip) => {
    var result = curTrip.copy();
    switch(curTrip.type) {
        //half last, half first
        case 'NNN': 
          if ((NNNCount >= (exemplarsPerTripletType / 2) || (Math.random > 0.5))){
            result.changeImageAt(2, getRandImg('N', curTrip));
          } else {
            result.changeImageAt(1, getRandImg('N', curTrip));
          }
          break;
        //half last, half first  
        case 'BBB':
          if ((AAACount >= (exemplarsPerTripletType / 2)) || (Math.random > 0.5)){
            result.changeImageAt(2, getRandImg('B', curTrip));
          } else {
            result.changeImageAt(1, getRandImg('N', curTrip));
          }
          break;
        //last  
        case 'NNB':
          result.changeImageAt(2, getRandImg('B', curTrip));
          break;
        //first  
        case 'BNN':
          result.changeImageAt(1, getRandImg('B', curTrip));
          break;
    }
    return result;
  };

  // creates a foil for every exemplar
  const createFoils = () => {
    var result = [];
    for(i in exemplars){
      result[i] = createFoil(exemplars[i]);
    }
    return result;
  };

  var foils = createFoils();

  // returns the foil of the given triplet
  const getFoil = (correctTriplet, i) => {
    return foils[i];
  };

  const testingInstructions = {
    type: 'instructions',
    pages: ['<div><p>In this part of the experiment, you will see two groups of images: Group A and Group B. Each group includes three images, which will appear one after the other.</p> <p>Your job is to indicate which group looks most familiar. Please pay close attention when the images are shown, as they will not be repeated.</p> <p>First, we will show you Groups A and B. After seeing all groups, you will decide which group looks most familiar.</p><p>To start the experiment, please press "J".</p><p>To see the instructions again, please press "F".</p></div>'],
    key_forward: 'j',
  };
   
  timeline.push(testingInstructions);
  
  // displys the instructions and three images for a given triplet
  const displayTriplet = (trip, ordering) => {
    const instructText = "<div> <p> To see Group " + ordering + ", please press “J”. Three images will appear, one after the other.</p> </div>"; 

    const tripletInstructions = {
      type: 'instructions',
      pages: [instructText],
      key_forward: 'j',
    };

    timeline.push(tripletInstructions);

    for (let i = 0; i < imageStructLength; i++) {
      const imgPath = getImagePath(trip.getImage(i)); 
      showFixationDot(timeline);

      const imagePrompt = {
        type: 'image-keyboard-response',
        stimulus: imgPath,
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000,        
      };

      timeline.push(imagePrompt);

    }
  };

  // asks the user what the correct triplet is
  const promptCorrectTrip = (tripA, tripB, ordering) => {
    var foilDif = 0;
    var sameCat = false;
    var foil = tripA.getImages().slice();
    var correct = tripA.getImages().slice();

    for (let i = 0; i < imageStructLength; i++){
      if (tripA.getImage(i).fileName != tripB.getImage(i).fileName){
        foilDif = i + 1;
        if (isNegativeImg(tripA.getImage(i)) === isNegativeImg(tripB.getImage(i))){
          sameCat = true;
        }
      }
    }
    if (ordering[0] === "correct") {
      foil = tripB.getImages().slice();
    } else {
      correct = tripB.getImages().slice();
    }

    const askPrompt = {
      type: 'html-keyboard-response',
      stimulus: ['<div><p>Using the mouse, if the image sequence in Option A looked more familiar, click “A”.</p><p>If the image sequence in Option B looked more familiar, click “B”.</p> <p>To continue, press "Enter".</p></div>'], 
      choices: ['a', 'b'],
      data: {foilTrip: foil, correctTrip: correct, tripOrdering: ordering, foilDifference: foilDif, sameCategoryTested: sameCat},
      on_finish: function(data) {
        if (((ordering[0] == "correct") && (data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('a'))) ||
          ((ordering[0] == "incorrect") && (data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('b')))) {
            data.correct = 2;
          } else {
            data.correct = (sameCat) ? 1 : 0;
          }
      }
    };

    const textPrompt = {
      type: 'instructions',
      pages: ['<div><p>Using the mouse, if the image sequence in Option A looked more familiar, click “A”.</p><p>If the image sequence in Option B looked more familiar, click “B”.</p> <p>To continue, press "Enter".</p></div>'], 
      key_forward: 'enter',
    };

    timeline.push(askPrompt);
    timeline.push(textPrompt);
  }

  // for every exemplar, display the exemplar and foil
  for (i in exemplars) {
    const curTriplet = exemplars[i];
    const foil = getFoil(curTriplet, i);
    const ordering = (Math.random() > 0.5) ? ["correct", "foil"] : ["foil", "correct"];
  
    const tripA = (ordering[0] === "correct") ? curTriplet : foil;
    const tripB = (tripA === curTriplet) ? foil : curTriplet;
  
    displayTriplet(tripA, "A");
    displayTriplet(tripB, "B");
    promptCorrectTrip(tripA, tripB, ordering);
  }

  const testingFinish = {
    type: 'instructions',
    pages: ['<div> <p> Thank you for finishing this part of the experiment. </p> <p>To continue, press "J".</p></div>'],
    key_forward: 'j',
  };

  timeline.push(testingFinish);

  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
        jsPsych.data.displayData();
      }
  });

  </script>
</html>
